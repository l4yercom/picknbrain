<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pick N Brain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #a5f3fc; /* a light cyan/sky color */
        }
        .app-title, .button-style {
            font-family: 'Luckiest Guy', cursive;
            letter-spacing: 1px;
        }
        .app-title {
            text-shadow: 3px 3px 0px #f97316; /* Orange shadow */
        }
        .card-container {
            perspective: 1000px;
        }
        .card-flip {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .card-flip.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .loader {
            border: 4px solid #dbeafe;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-2xl mx-auto">

        <!-- Pantalla de Inicio -->
        <div id="start-screen" class="text-center p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border-4 border-white">
            <h1 class="app-title text-6xl md:text-7xl text-blue-600 mb-8">Pick N Brain</h1>
            <div class="mb-8">
                <label for="num-players-input" class="block text-slate-700 font-bold text-xl mb-2">Número de Jugadores:</label>
                <input type="number" id="num-players-input" value="1" min="1" max="4" class="w-32 text-center text-2xl font-bold p-2 border-4 border-blue-300 rounded-lg focus:ring-4 focus:ring-orange-400 focus:outline-none">
            </div>
            <button id="init-game-btn" class="button-style bg-orange-500 hover:bg-orange-600 text-white py-4 px-10 rounded-full text-2xl shadow-lg transition-transform transform hover:scale-105">
                Iniciar Juego
            </button>
        </div>
        
        <!-- Pantalla de Nombres -->
        <div id="name-screen" class="hidden text-center p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border-4 border-white">
            <h2 class="text-3xl font-bold text-blue-800 mb-6">¿Quiénes van a jugar?</h2>
            <div id="name-inputs-container" class="space-y-4 mb-8">
                <!-- Inputs se generan aquí -->
            </div>
            <button id="start-game-btn" class="button-style bg-orange-500 hover:bg-orange-600 text-white py-4 px-10 rounded-full text-2xl shadow-lg transition-transform transform hover:scale-105">
                ¡A Jugar!
            </button>
        </div>

        <!-- Pantalla de Juego -->
        <div id="game-screen" class="hidden">
             <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border-4 border-white p-4 sm:p-6">
                <div id="player-scores" class="flex justify-center gap-4 mb-4 text-slate-700 flex-wrap">
                   <!-- Marcadores de jugadores -->
                </div>
                <h2 id="turn-indicator" class="text-center text-3xl font-bold text-orange-600 mb-2"></h2>
                <h3 class="text-center text-xl font-bold text-slate-600 mb-4">Ronda <span id="round-counter">1 / 5</span></h3>


                <!-- Temporizador -->
                <div class="w-full bg-blue-200 rounded-full h-4 mb-4 overflow-hidden border border-blue-300">
                    <div id="timer-bar" class="bg-gradient-to-r from-yellow-300 to-orange-500 h-full rounded-full transition-all duration-1000 linear"></div>
                </div>
                
                <div class="card-container h-[350px] md:h-[400px]">
                    <div id="card-flip" class="w-full h-full card-flip">
                        <!-- Frente de la tarjeta (Imagen) -->
                        <div id="card-front" class="card-front bg-white rounded-xl p-4 flex flex-col items-center justify-center border-4 border-blue-400">
                            <!-- Estado de Carga -->
                            <div id="loading-state" class="text-center text-slate-600">
                                <div class="loader mx-auto"></div>
                                <p class="mt-4 text-lg font-semibold">Creando una escena...</p>
                            </div>
                            <!-- Contenido de la Tarjeta -->
                            <div id="card-content" class="hidden w-full h-full">
                               <img id="card-image" src="" alt="Imagen generada por IA" class="w-full h-full object-contain rounded-lg">
                            </div>
                        </div>

                        <!-- Dorso de la tarjeta (Pregunta) -->
                        <div id="card-back" class="card-back bg-white rounded-xl p-6 flex flex-col justify-center items-center border-4 border-blue-400">
                            <div id="question-area" class="w-full text-center">
                                <p id="question-text" class="text-2xl md:text-3xl font-bold text-slate-800 mb-6"></p>
                                <div id="text-answer-area" class="flex flex-col sm:flex-row items-center justify-center gap-2 w-full max-w-md mx-auto">
                                    <input type="text" id="answer-input" class="w-full sm:flex-grow border-4 border-blue-300 rounded-full p-3 text-lg focus:ring-4 focus:ring-orange-400 focus:outline-none" placeholder="Escribe tu respuesta...">
                                    <button id="submit-answer-btn" class="button-style w-full mt-2 sm:mt-0 sm:w-auto bg-orange-500 hover:bg-orange-600 text-white py-3 px-6 rounded-full text-xl transition-colors">Enviar</button>
                                </div>
                                <div id="feedback-message" class="mt-6 text-2xl font-bold h-8"></div>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
             <button id="next-btn" class="button-style hidden mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                Siguiente Turno
            </button>
        </div>

        <!-- Pantalla Final -->
        <div id="end-screen" class="hidden text-center p-8 bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl border-4 border-white">
            <h1 class="app-title text-5xl md:text-6xl text-blue-600 mb-4">¡Juego Terminado!</h1>
            <h2 id="winner-declaration" class="text-3xl font-bold text-orange-600 mb-6"></h2>
            <div id="final-scores-container" class="space-y-2 text-2xl text-slate-700 font-bold mb-8">
                <!-- Puntajes Finales -->
            </div>
            <button id="restart-btn" class="button-style bg-orange-500 hover:bg-orange-600 text-white py-4 px-10 rounded-full text-2xl shadow-lg transition-transform transform hover:scale-105">
                Jugar de Nuevo
            </button>
        </div>
    </div>

    <script>
        // --- ELEMENTOS DE LA UI ---
        const startScreen = document.getElementById('start-screen');
        const nameScreen = document.getElementById('name-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        
        const initGameBtn = document.getElementById('init-game-btn');
        const numPlayersInput = document.getElementById('num-players-input');
        const nameInputsContainer = document.getElementById('name-inputs-container');
        const startGameBtn = document.getElementById('start-game-btn');
        
        const restartBtn = document.getElementById('restart-btn');
        const nextBtn = document.getElementById('next-btn');
        
        const roundCounterEl = document.getElementById('round-counter');
        const playerScoresEl = document.getElementById('player-scores');
        const turnIndicatorEl = document.getElementById('turn-indicator');
        const finalScoresContainer = document.getElementById('final-scores-container');
        const winnerDeclarationEl = document.getElementById('winner-declaration');
        
        const timerBar = document.getElementById('timer-bar');
        const cardFlip = document.getElementById('card-flip');
        const cardImage = document.getElementById('card-image');
        const questionText = document.getElementById('question-text');
        const feedbackMessage = document.getElementById('feedback-message');
        const loadingState = document.getElementById('loading-state');
        const cardContent = document.getElementById('card-content');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        
        // --- ESTADO DEL JUEGO ---
        let players = [];
        let currentPlayerIndex = 0;
        let currentRound = 1;
        let timer;
        let currentCardData = null;
        let preloadedCard = null;
        let isPreloading = false;
        const TOTAL_ROUNDS = 5;
        const TOTAL_TIME = 15;
        let sessionToken = null;
        const BACKEND_URL = '';

        const characterList = [
            "Mickey Mouse", "Bob Esponja", "Pikachu", "Elsa de Frozen", "Buzz Lightyear", "Shrek", "Spider-Man", "Peppa Pig", "Winnie the Pooh", "Un Minion", "Mario Bros", "Sonic the Hedgehog", "Dora la Exploradora", "Goku de Dragon Ball", "Hello Kitty", "Rayo McQueen", "Woody de Toy Story", "Simba de El Rey León", "Stitch", "Olaf de Frozen", "Chase de Paw Patrol", "Bluey", "Pocoyó", "Naruto", "Iron Man", "Capitán América", "Hulk", "Batman", "Superman", "La Mujer Maravilla", "Harry Potter", "Hermione Granger", "Snoopy", "Garfield", "Bugs Bunny", "El Pato Lucas", "Tom y Jerry", "Scooby-Doo", "Popeye el Marino", "He-Man", "She-Ra", "Optimus Prime", "Megatron", "Leonardo de las Tortugas Ninja", "Donatello de las Tortugas Ninja", "Bart Simpson", "Homero Simpson", "Darth Vader", "Yoda", "Chewbacca"
        ];

        const actionList = [
            // Deportes y actividades físicas (25)
            "jugando al fútbol en la playa",
            "montando en bicicleta por el parque",
            "nadando en una piscina gigante",
            "corriendo una maratón divertida",
            "saltando la cuerda con amigos",
            "practicando yoga en la montaña",
            "escalando un árbol muy alto",
            "patinando sobre hielo en un lago congelado",
            "jugando al baloncesto con un balón gigante",
            "haciendo gimnasia en el jardín",
            "bailando ballet en un escenario",
            "practicando artes marciales con un maestro sabio",
            "jugando al tenis con una raqueta enorme",
            "haciendo senderismo en un bosque encantado",
            "remando en un bote por un río tranquilo",
            "jugando al golf con un palo mágico",
            "haciendo surf en una ola gigante",
            "jugando al voleibol en la arena",
            "practicando esgrima con espadas de juguete",
            "lanzando un frisbee a un perro amigable",
            "haciendo piruetas en un trampolín",
            "jugando a la rayuela en la calle",
            "haciendo malabares con pelotas de colores",
            "practicando tiro con arco en el bosque",
            "jugando a las escondidas en un laberinto",

            // Comida y alimentación (25)
            "comiendo una pizza gigante con todos los toppings",
            "cocinando galletas con chispas de chocolate",
            "preparando un pastel de cumpleaños enorme",
            "disfrutando de un helado de tres sabores",
            "haciendo un picnic en el campo",
            "comiendo palomitas de maíz en el cine",
            "bebiendo un batido de frutas tropicales",
            "asando malvaviscos en una fogata",
            "decorando cupcakes con glaseado de colores",
            "haciendo una ensalada fresca con verduras del jardín",
            "comiendo espagueti con albóndigas",
            "preparando sándwiches para un viaje",
            "disfrutando de un desayuno con panqueques y sirope",
            "comiendo sushi con palillos gigantes",
            "haciendo una barbacoa con amigos",
            "comiendo tacos picantes en una fiesta",
            "preparando limonada casera en verano",
            "disfrutando de una sopa caliente en invierno",
            "comiendo frutas exóticas en una isla",
            "haciendo una fondue de chocolate con frutas",
            "comiendo hamburguesas con papas fritas",
            "preparando un batido de proteínas después de hacer ejercicio",
            "disfrutando de un café con leche y un croissant",
            "comiendo churros con chocolate caliente",
            "preparando una paella gigante para la familia",

            // Viajes y transporte (25)
            "volando en un avión por las nubes",
            "navegando en un barco pirata por el océano",
            "viajando en tren por paisajes nevados",
            "conduciendo un coche de carreras por una pista",
            "montando en un globo aerostático al amanecer",
            "explorando una cueva misteriosa con una linterna",
            "viajando en autobús por la ciudad",
            "montando en un camello por el desierto",
            "volando en una alfombra mágica por el cielo",
            "viajando en submarino por el fondo del mar",
            "conduciendo una moto por una carretera sin fin",
            "montando en un elefante por la selva",
            "viajando en teleférico por las montañas",
            "conduciendo un tractor por una granja",
            "montando en un trineo tirado por perros",
            "viajando en góndola por Venecia",
            "conduciendo un monopatín por la ciudad",
            "montando en un hoverboard futurista",
            "viajando en un cohete a la luna",
            "conduciendo un kart en un circuito",
            "montando en un monociclo por el circo",
            "viajando en un barco de vapor por un lago",
            "conduciendo un coche anfibio por tierra y agua",
            "montando en un jet ski en el mar",
            "viajando en un autobús de dos pisos por Londres",

            // Fantasía y aventuras (25)
            "luchando contra un dragón en un castillo",
            "buscando un tesoro escondido en una isla",
            "explorando un bosque encantado con hadas",
            "rescatando a una princesa de una torre alta",
            "enfrentándose a un monstruo marino en el océano",
            "descubriendo un portal a otra dimensión",
            "volando con un grifo por el cielo",
            "resolviendo un enigma en un templo antiguo",
            "escapando de una trampa en una pirámide",
            "encontrando un artefacto mágico en ruinas",
            "luchando contra un ejército de esqueletos",
            "haciendo un pacto con un duende del bosque",
            "explorando una ciudad subterránea perdida",
            "enfrentándose a un gigante en las nubes",
            "descubriendo un huevo de dragón",
            "volando en una escoba mágica",
            "resolviendo un misterio en una mansión embrujada",
            "escapando de una mazmorra oscura",
            "encontrando un mapa del tesoro",
            "luchando contra un hechicero malvado",
            "haciendo amigos con un unicornio",
            "explorando un reino submarino",
            "enfrentándose a un minotauro en un laberinto",
            "descubriendo una espada legendaria",
            "volando en un pegaso por el cielo estrellado",

            // Actividades diarias (25)
            "leyendo un libro en la cama",
            "desayunando en la cocina",
            "cepillándose los dientes en el baño",
            "vistiendo su ropa favorita",
            "jugando con juguetes en su habitación",
            "ayudando a limpiar la casa",
            "regando las plantas del jardín",
            "paseando al perro por el parque",
            "haciendo la tarea en el escritorio",
            "viendo la televisión en el sofá",
            "escuchando música con auriculares",
            "hablando por teléfono con un amigo",
            "durmiendo una siesta en el sillón",
            "comprando en el supermercado",
            "cocinando la cena para la familia",
            "lavando los platos después de comer",
            "doblando la ropa limpia",
            "organizando sus libros en la estantería",
            "escribiendo una carta a un amigo",
            "dibujando en un cuaderno",
            "pintando con acuarelas",
            "jugando a videojuegos en la consola",
            "construyendo una torre con bloques",
            "resolviendo un rompecabezas",
            "mirando las estrellas por la ventana",

            // Celebraciones (25)
            "celebrando un cumpleaños con un pastel",
            "abriendo regalos en Navidad",
            "disfrazándose para Halloween",
            "lanzando fuegos artificiales en Año Nuevo",
            "decorando el árbol de Navidad",
            "cantando villancicos con amigos",
            "haciendo una fiesta de disfraces",
            "soplando las velas de un pastel",
            "recibiendo un regalo sorpresa",
            "bailando en una boda",
            "celebrando el Día de Acción de Gracias",
            "haciendo una piñata para una fiesta",
            "disfrutando de un desfile",
            "celebrando el Día de la Madre/Padre",
            "haciendo una tarjeta de felicitación",
            "celebrando una graduación",
            "disfrutando de un carnaval",
            "haciendo una hoguera en la playa",
            "celebrando una victoria deportiva",
            "haciendo un brindis con zumo",
            "celebrando el Día del Niño",
            "disfrutando de un concierto al aire libre",
            "celebrando un aniversario",
            "haciendo una fiesta de pijamas",
            "celebrando el fin de semana",

            // Naturaleza (25)
            "explorando un bosque frondoso",
            "observando pájaros en el cielo",
            "plantando flores en el jardín",
            "recogiendo setas en el campo",
            "caminando por la orilla del mar",
            "observando peces en un río",
            "escalando una montaña rocosa",
            "haciendo un muñeco de nieve",
            "observando mariposas en un prado",
            "recogiendo hojas de otoño",
            "haciendo un castillo de arena en la playa",
            "observando estrellas en la noche",
            "caminando bajo la lluvia con un paraguas",
            "observando ranas en un estanque",
            "recogiendo conchas marinas",
            "haciendo un nido para pájaros",
            "observando ardillas en un árbol",
            "caminando por un sendero nevado",
            "observando abejas en una colmena",
            "recogiendo bayas silvestres",
            "haciendo una corona de flores",
            "observando luciérnagas en la oscuridad",
            "caminando por un campo de girasoles",
            "observando hormigas en un hormiguero",
            "recogiendo piedras de colores",

            // Creatividad (25)
            "pintando un cuadro abstracto",
            "esculpiendo una figura de arcilla",
            "escribiendo un poema en un cuaderno",
            "tocando la guitarra en un concierto",
            "cantando una canción en el escenario",
            "bailando una coreografía moderna",
            "diseñando un vestido de moda",
            "construyendo una maqueta de una ciudad",
            "haciendo una escultura de hielo",
            "creando un collage con revistas",
            "escribiendo una historia de aventuras",
            "tocando el piano en un recital",
            "cantando en un coro",
            "bailando flamenco",
            "diseñando un videojuego",
            "construyendo un robot",
            "haciendo una escultura de arena",
            "creando un mural en la pared",
            "escribiendo una obra de teatro",
            "tocando la batería en una banda",
            "cantando ópera",
            "bailando hip hop",
            "diseñando un coche futurista",
            "construyendo una casa en el árbol",
            "haciendo una escultura de madera",

            // Espacio y ciencia (25)
            "volando por el espacio en una nave espacial",
            "explorando un planeta desconocido",
            "observando estrellas con un telescopio",
            "flotando en gravedad cero",
            "caminando por la luna",
            "construyendo un cohete espacial",
            "observando un eclipse solar",
            "visitando una estación espacial",
            "descubriendo una nueva galaxia",
            "haciendo un experimento científico",
            "observando un cometa",
            "viajando a la velocidad de la luz",
            "explorando un agujero negro",
            "observando una lluvia de meteoritos",
            "visitando un laboratorio espacial",
            "descubriendo una nueva especie alienígena",
            "haciendo un mapa estelar",
            "observando una supernova",
            "viajando en el tiempo",
            "explorando un universo paralelo",
            "observando un agujero de gusano",
            "visitando una base lunar",
            "descubriendo un nuevo elemento",
            "haciendo un robot explorador",
            "observando una nebulosa",

            // Emociones (25)
            "riendo a carcajadas con un chiste",
            "llorando de alegría por una sorpresa",
            "sorprendido por un truco de magia",
            "enojado por perder un juego",
            "asustado por un ruido fuerte",
            "feliz por un regalo",
            "triste por una despedida",
            "aburrido en una clase",
            "emocionado por un viaje",
            "confundido por un acertijo",
            "orgulloso de un logro",
            "avergonzado por un error",
            "relajado en la playa",
            "nervioso antes de un examen",
            "curioso por un misterio",
            "agradecido por la ayuda",
            "frustrado por un problema",
            "contento con amigos",
            "preocupado por algo",
            "valiente ante un desafío",
            "calmado en la naturaleza",
            "impaciente por esperar",
            "aliviado después de un susto",
            "inspirado por una idea",
            "melancólico al recordar",

            // Trabajo y profesiones (25)
            "trabajando como médico en un hospital",
            "enseñando en una escuela",
            "construyendo una casa como arquitecto",
            "apagando un incendio como bombero",
            "investigando en un laboratorio como científico",
            "pilotando un avión como piloto",
            "cocinando en un restaurante como chef",
            "diseñando ropa como diseñador de moda",
            "escribiendo un libro como escritor",
            "pintando un cuadro como artista",
            "cantando en un concierto como cantante",
            "bailando en un escenario como bailarín",
            "programando un videojuego como programador",
            "diseñando un coche como ingeniero",
            "cuidando animales como veterinario",
            "explorando el espacio como astronauta",
            "trabajando en una granja como granjero",
            "sirviendo comida como camarero",
            "cortando el pelo como peluquero",
            "arreglando coches como mecánico",
            "trabajando en una oficina como administrativo",
            "vendiendo productos como vendedor",
            "trabajando en un banco como banquero",
            "diseñando edificios como ingeniero civil",
            "trabajando en un supermercado como cajero",

            // Hobbies (25)
            "coleccionando sellos antiguos",
            "jugando ajedrez en el parque",
            "haciendo maquetas de aviones",
            "tejiendo una bufanda de lana",
            "fotografiando paisajes hermosos",
            "aprendiendo a tocar un instrumento",
            "leyendo cómics de superhéroes",
            "resolviendo crucigramas difíciles",
            "haciendo jardinería en el patio",
            "cocinando recetas exóticas",
            "pintando miniaturas de fantasía",
            "escribiendo un diario personal",
            "practicando caligrafía japonesa",
            "observando aves con binoculares",
            "haciendo papiroflexia con papel de colores",
            "coleccionando monedas antiguas",
            "jugando a videojuegos retro",
            "haciendo puzzles de mil piezas",
            "aprendiendo un nuevo idioma",
            "haciendo manualidades con fieltro",
            "fotografiando animales salvajes",
            "leyendo novelas de misterio",
            "resolviendo sudokus complejos",
            "haciendo pan casero",
            "practicando la magia de cerca",

            // Estaciones del año (25)
            "disfrutando del sol en verano",
            "recogiendo hojas en otoño",
            "jugando en la nieve en invierno",
            "plantando flores en primavera",
            "haciendo un picnic en verano",
            "saltando en charcos en otoño",
            "patinando sobre hielo en invierno",
            "observando los brotes en primavera",
            "nadando en el mar en verano",
            "recogiendo castañas en otoño",
            "haciendo un muñeco de nieve en invierno",
            "paseando por un campo de flores en primavera",
            "comiendo helado en verano",
            "disfrazándose para Halloween en otoño",
            "bebiendo chocolate caliente en invierno",
            "observando los pájaros en primavera",
            "haciendo una barbacoa en verano",
            "recogiendo uvas en otoño",
            "esquiando en la montaña en invierno",
            "haciendo un jardín en primavera",
            "tomando el sol en la playa en verano",
            "caminando por un bosque de colores en otoño",
            "construyendo un iglú en invierno",
            "observando los animales recién nacidos en primavera",
            "disfrutando de un festival de verano",

            // Clima (25)
            "bailando bajo la lluvia con un paraguas",
            "disfrutando de un día soleado en el parque",
            "jugando en la nieve durante una tormenta",
            "refugiándose de un viento fuerte",
            "observando un arcoíris después de la lluvia",
            "corriendo bajo una llovizna ligera",
            "tomando el sol en un día caluroso",
            "construyendo un fuerte en la nieve",
            "volando una cometa en un día ventoso",
            "observando los relámpagos de una tormenta",
            "caminando por la niebla matutina",
            "disfrutando de un día fresco y nublado",
            "haciendo un ángel de nieve",
            "protegiéndose de una granizada",
            "observando las nubes pasar",
            "jugando con el rocío de la mañana",
            "disfrutando de un día templado",
            "haciendo una guerra de bolas de nieve",
            "protegiéndose de una tormenta de arena",
            "observando la escarcha en los árboles",
            "caminando bajo la luna llena",
            "disfrutando de un día de brisa marina",
            "haciendo un picnic en un día despejado",
            "observando la nieve caer suavemente",
            "refugiándose de una ola de calor",

            // Tecnología (25)
            "jugando a videojuegos en una consola futurista",
            "programando un robot inteligente",
            "diseñando una aplicación móvil",
            "usando unas gafas de realidad virtual",
            "volando un dron por el cielo",
            "creando música con un sintetizador",
            "editando un video en el ordenador",
            "navegando por internet en una tablet",
            "construyendo un circuito electrónico",
            "usando un smartwatch para medir sus pasos",
            "imprimiendo un objeto en 3D",
            "creando arte digital con un lápiz óptico",
            "jugando con un robot de juguete",
            "usando un proyector holográfico",
            "aprendiendo a codificar en un campamento",
            "creando un mundo virtual",
            "usando un traductor universal",
            "jugando a un juego de mesa digital",
            "usando un asistente de voz inteligente",
            "creando animaciones por ordenador",
            "usando un teclado virtual",
            "jugando con un coche teledirigido",
            "usando un dispositivo de teletransporte",
            "creando un avatar digital",
            "usando un dispositivo de levitación",

            // Música y espectáculos (25)
            "tocando la guitarra eléctrica en un concierto de rock",
            "cantando en un escenario de ópera",
            "bailando en un musical de Broadway",
            "dirigiendo una orquesta sinfónica",
            "tocando el piano en un recital clásico",
            "cantando en un coro gospel",
            "bailando hip hop en la calle",
            "tocando la batería en una banda de jazz",
            "cantando karaoke con amigos",
            "bailando salsa en una fiesta latina",
            "tocando el violín en una orquesta de cámara",
            "cantando en un festival de música pop",
            "bailando ballet en un teatro",
            "tocando la flauta en un grupo folclórico",
            "cantando en un concierto benéfico",
            "bailando claqué en un espectáculo",
            "tocando el saxofón en un club de blues",
            "cantando en un musical escolar",
            "bailando breakdance en una competición",
            "tocando el arpa en un concierto de música celta",
            "cantando en un coro de iglesia",
            "bailando tango en una milonga",
            "tocando la trompeta en una banda militar",
            "cantando en un concierto de rock alternativo",
            "bailando samba en el carnaval",

            // Animales (25)
            "jugando con un cachorro en el jardín",
            "alimentando a los patos en el estanque",
            "montando a caballo por el campo",
            "observando monos en la selva",
            "acariciando a un gato suave",
            "jugando con un delfín en el mar",
            "observando leones en la sabana",
            "alimentando a los pájaros en el balcón",
            "montando en un pony en la granja",
            "observando pingüinos en el hielo",
            "acariciando a un conejo esponjoso",
            "jugando con un perro salchicha",
            "observando jirafas en el zoológico",
            "alimentando a los peces en el acuario",
            "montando en un camello en el desierto",
            "observando osos polares en el ártico",
            "acariciando a un hámster pequeño",
            "jugando con un loro que habla",
            "observando elefantes en la India",
            "alimentando a las tortugas en el río",
            "montando en un burro por la montaña",
            "observando tigres en la jungla",
            "acariciando a un cobaya",
            "jugando con un pez de colores",
            "observando cebras en la llanura",

            // Superhéroes (25)
            "volando como Superman por la ciudad",
            "luchando contra villanos como Batman",
            "lanzando telarañas como Spider-Man",
            "usando su martillo como Thor",
            "corriendo a supervelocidad como Flash",
            "lanzando escudos como Capitán América",
            "usando su fuerza como Hulk",
            "disparando flechas como Hawkeye",
            "usando su magia como Doctor Strange",
            "infiltrándose como Black Widow",
            "controlando el clima como Storm",
            "usando su armadura como Iron Man",
            "luchando con garras como Wolverine",
            "usando su lazo de la verdad como Wonder Woman",
            "controlando el agua como Aquaman",
            "usando su anillo como Green Lantern",
            "luchando con su espada como Samurai Jack",
            "usando su telequinesis como Jean Grey",
            "cambiando de forma como Mystique",
            "usando su superoído como Daredevil",
            "luchando con su bastón como Robin",
            "usando su visión de calor como Cyclops",
            "controlando el hielo como Iceman",
            "luchando con su arco como Green Arrow",
            "usando su fuerza sobrehumana como She-Hulk",

            // Magia (25)
            "lanzando un hechizo mágico",
            "convirtiendo objetos en animales",
            "haciendo desaparecer una moneda",
            "volando en una escoba mágica",
            "creando una poción mágica",
            "leyendo un libro de hechizos",
            "invocando un espíritu amigable",
            "transformándose en un animal",
            "haciendo levitar objetos",
            "creando ilusiones ópticas",
            "hablando con animales",
            "controlando los elementos (agua, fuego, tierra, aire)",
            "haciendo crecer plantas al instante",
            "curando heridas con magia",
            "creando un escudo protector",
            "teletransportándose a otro lugar",
            "haciendo aparecer comida",
            "creando un portal mágico",
            "haciendo que los objetos hablen",
            "controlando el tiempo",
            "creando un arcoíris",
            "haciendo que los juguetes cobren vida",
            "creando una bola de cristal",
            "haciendo que la lluvia se detenga",
            "creando un jardín mágico",

            // Agua y buceo (25)
            "nadando con delfines en el océano",
            "buceando en un arrecife de coral",
            "explorando un barco hundido",
            "jugando en la playa con la arena",
            "construyendo un castillo de arena gigante",
            "haciendo surf en una ola enorme",
            "navegando en un velero por el mar",
            "pescando en un lago tranquilo",
            "remando en un kayak por un río",
            "observando tortugas marinas",
            "jugando con una pelota en el agua",
            "haciendo snorkel en una laguna cristalina",
            "explorando una cueva submarina",
            "saltando desde un trampolín a la piscina",
            "haciendo una guerra de agua con pistolas de agua",
            "observando ballenas en el mar",
            "jugando al voleibol de playa",
            "haciendo un picnic en la orilla del río",
            "construyendo una presa en un arroyo",
            "observando medusas en el acuario",
            "jugando con burbujas en el agua",
            "haciendo una carrera de natación",
            "explorando un manglar en canoa",
            "observando estrellas de mar",
            "jugando con un flotador gigante"
        ];
        
        // --- LÓGICA DE LA API DE GEMINI ---
        async function fetchWithBackoff(url, options, maxRetries = 3) { 
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`API Error Response: ${response.status}`, errorBody);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        console.error("Max retries reached. Failing.", error);
                        throw error;
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    console.warn(`Attempt ${attempt} failed. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        async function generateImage(prompt) {
            const result = await fetchWithBackoff(`${BACKEND_URL}/api/game/generate-scene`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({ scenePrompt: prompt })
            });
            return result.sceneImage;
        }

        async function generateContentFromImage(base64ImageData) {
            const result = await fetchWithBackoff(`${BACKEND_URL}/api/game/analyze-scene`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({ sceneData: base64ImageData })
            });
            return { question: result.challenge, answer: result.solution };
        }

        async function validateAnswerWithAI(question, correctAnswer, userAnswer) {
            const result = await fetchWithBackoff(`${BACKEND_URL}/api/game/validate-challenge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`
                },
                body: JSON.stringify({
                    challenge: question,
                    solution: correctAnswer,
                    playerResponse: userAnswer
                })
            });
            return result.correct ? 'si' : 'no';
        }

        // --- LÓGICA DEL JUEGO ---

        function generateScenePrompt() {
            const numChars = Math.random() < 0.6 ? 1 : 2; // 60% de probabilidad de 1 personaje
            let selectedChars = [];
            let prompt = '';
            let tempList = [...characterList];

            for (let i = 0; i < numChars; i++) {
                const charIndex = Math.floor(Math.random() * tempList.length);
                selectedChars.push(tempList.splice(charIndex, 1)[0]);
            }

            const action = actionList[Math.floor(Math.random() * actionList.length)];
            
            if (numChars === 1) {
                prompt = `${selectedChars[0]} ${action}`;
            } else {
                prompt = `${selectedChars[0]} y ${selectedChars[1]} ${action}`;
            }
            
            return `${prompt}, en un brillante y colorido estilo de dibujo animado para niños.`;
        }

        async function preloadNextCard() {
            if (isPreloading) return;
            isPreloading = true;
            try {
                const scenePrompt = generateScenePrompt();
                const imageBase64 = await generateImage(scenePrompt);
                const content = await generateContentFromImage(imageBase64);
                preloadedCard = { imageBase64, content };
            } catch (error) {
                console.error("Error preloading next card:", error);
                preloadedCard = { error: true };
            } finally {
                isPreloading = false;
            }
        }


        function setupNameInputs(num) {
            nameInputsContainer.innerHTML = '';
            for (let i = 1; i <= num; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Nombre Jugador ${i}`;
                input.className = 'w-full max-w-sm mx-auto text-center text-xl font-bold p-2 border-4 border-blue-300 rounded-lg focus:ring-4 focus:ring-orange-400 focus:outline-none';
                nameInputsContainer.appendChild(input);
            }
        }

        function startGame() {
            gameScreen.classList.remove('hidden');
            currentPlayerIndex = 0;
            currentRound = 1;
            players.forEach(p => p.score = 0);
            updatePlayerScoresUI();
            generateAndDisplayCard();
        }

        async function generateAndDisplayCard() {
            resetCard();
            roundCounterEl.textContent = `${currentRound} / ${TOTAL_ROUNDS}`;
            turnIndicatorEl.textContent = `Turno de: ${players[currentPlayerIndex].name}`;
            
            if (preloadedCard && !preloadedCard.error) {
                // Usar datos precargados
                cardImage.src = `data:image/png;base64,${preloadedCard.imageBase64}`;
                currentCardData = preloadedCard.content;
                questionText.textContent = currentCardData.question;
                loadingState.classList.add('hidden');
                cardContent.classList.remove('hidden');
                startTimer();
                preloadedCard = null;
            } else {
                // Generar la primera tarjeta o si la precarga falló
                try {
                    const scenePrompt = generateScenePrompt();
                    const imageBase64 = await generateImage(scenePrompt);
                    cardImage.src = `data:image/png;base64,${imageBase64}`;
                    const content = await generateContentFromImage(imageBase64);
                    currentCardData = content;
                    questionText.textContent = content.question;

                    loadingState.classList.add('hidden');
                    cardContent.classList.remove('hidden');
                    startTimer();
                } catch(error) {
                    console.error("Error generating card:", error);
                    loadingState.innerHTML = `<p class="text-red-500">Error al generar la tarjeta. Intenta recargar la página.</p>`;
                    return;
                }
            }
            
            // Precargar la siguiente tarjeta, si no es el último turno del juego
            const isLastTurnOfGame = (currentRound === TOTAL_ROUNDS) && (currentPlayerIndex === players.length - 1);
            if (!isLastTurnOfGame) {
                preloadNextCard();
            }
        }
        
        function startTimer() {
            let timeLeft = TOTAL_TIME;
            timerBar.style.width = '100%';

            timer = setInterval(() => {
                timeLeft--;
                const percentageLeft = (timeLeft / TOTAL_TIME) * 100;
                timerBar.style.width = `${percentageLeft}%`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showQuestion();
                }
            }, 1000);
        }
        
        function showQuestion() {
            clearInterval(timer);
            cardFlip.classList.add('flipped');
        }

        async function handleAnswer() {
            const userAnswer = answerInput.value.trim();
            if (!userAnswer) {
                feedbackMessage.textContent = "¡Escribe algo!";
                feedbackMessage.style.color = '#f97316'; // orange-500
                return;
            }

            clearInterval(timer);
            showQuestion();

            answerInput.disabled = true;
            submitAnswerBtn.disabled = true;
            feedbackMessage.textContent = "Revisando...";
            feedbackMessage.style.color = '#64748b'; // slate-500

            try {
                const validationResult = await validateAnswerWithAI(currentCardData.question, currentCardData.answer, userAnswer);

                if (validationResult === 'si') {
                    players[currentPlayerIndex].score++;
                    feedbackMessage.textContent = "¡Correcto!";
                    feedbackMessage.style.color = '#22c55e'; // green-500
                } else {
                    feedbackMessage.textContent = `Era: ${currentCardData.answer}`;
                    feedbackMessage.style.color = '#ef4444'; // red-500
                }
            } catch (error) {
                 console.error("Error validating answer:", error);
                 feedbackMessage.textContent = "Error al validar";
                 feedbackMessage.style.color = '#ef4444';
            }

            updatePlayerScoresUI();
            nextBtn.classList.remove('hidden');
        }

        function updatePlayerScoresUI() {
            playerScoresEl.innerHTML = '';
            players.forEach((player, index) => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = `p-2 rounded-lg font-bold transition-all ${index === currentPlayerIndex ? 'bg-orange-500 text-white shadow-md' : 'bg-blue-100 text-blue-800'}`;
                scoreDiv.innerHTML = `${player.name}: <span class="ml-2">${player.score}</span>`;
                playerScoresEl.appendChild(scoreDiv);
            });
        }
        
        function resetCard() {
            cardFlip.classList.remove('flipped');
            feedbackMessage.textContent = '';
            nextBtn.classList.add('hidden');
            loadingState.classList.remove('hidden');
            cardContent.classList.add('hidden');
            currentCardData = null;
            answerInput.value = '';
            answerInput.disabled = false;
            submitAnswerBtn.disabled = false;
        }

        function endGame() {
            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            
            finalScoresContainer.innerHTML = '';
            players.sort((a, b) => b.score - a.score);
            
            const highScore = players[0].score;
            const winners = players.filter(p => p.score === highScore);

            if (winners.length > 1) {
                winnerDeclarationEl.textContent = '¡Es un empate!';
            } else {
                winnerDeclarationEl.textContent = `¡Ganador: ${winners[0].name}!`;
            }

            players.forEach(player => {
                const scoreEntry = document.createElement('div');
                scoreEntry.innerHTML = `${player.name}: <span class="ml-2">${player.score} puntos</span>`;
                finalScoresContainer.appendChild(scoreEntry);
            });
        }

        // --- EVENT LISTENERS ---
        initGameBtn.addEventListener('click', () => {
            const numPlayers = parseInt(numPlayersInput.value);
            if (numPlayers > 0 && numPlayers <= 4) {
                setupNameInputs(numPlayers);
                startScreen.classList.add('hidden');
                nameScreen.classList.remove('hidden');
            }
        });
        
        startGameBtn.addEventListener('click', async () => {
            const nameInputs = nameInputsContainer.querySelectorAll('input');
            players = [];
            let allNamesValid = true;
            nameInputs.forEach((input, index) => {
                const name = input.value.trim();
                if (name) {
                    players.push({ name: name, score: 0 });
                } else {
                    allNamesValid = false;
                }
            });

            if (allNamesValid && players.length > 0) {
                try {
                    // Initialize session
                    const sessionResponse = await fetch(`${BACKEND_URL}/api/game/start-session`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (!sessionResponse.ok) {
                        throw new Error('Failed to start session');
                    }
                    const sessionData = await sessionResponse.json();
                    sessionToken = sessionData.sessionToken;

                    nameScreen.classList.add('hidden');
                    startGame();
                } catch (error) {
                    console.error('Error starting session:', error);
                    alert('Error al iniciar la sesión. Intenta recargar la página.');
                }
            } else {
                alert("Por favor, ingresa un nombre para cada jugador.");
            }
        });

        restartBtn.addEventListener('click', () => {
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });

        submitAnswerBtn.addEventListener('click', handleAnswer);
        
        answerInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitAnswerBtn.click();
            }
        });

        nextBtn.addEventListener('click', () => {
            currentPlayerIndex++;
            if (currentPlayerIndex >= players.length) {
                currentPlayerIndex = 0;
                currentRound++;
            }

            if (currentRound > TOTAL_ROUNDS) {
                endGame();
            } else {
                generateAndDisplayCard();
            }
        });
    </script>
</body>
</html>
